<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: MultiVault
  
    &mdash; Documentation by YARD 0.8.7.6
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!MultiVault.html";
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (M)</a> &raquo;
    
    
    <span class="title">MultiVault</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: MultiVault
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName"><span class='object_link'><a href="PreVault.html" title="PreVault (class)">PreVault</a></span></span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Hashr</li>
          
            <li class="next"><span class='object_link'><a href="PreVault.html" title="PreVault (class)">PreVault</a></span></li>
          
            <li class="next">MultiVault</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
  
  
  
    <dt class="r2 last">Defined in:</dt>
    <dd class="r2 last">lib/multivault.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>todo init vectors belong by their respective data, not in cryptoset, make
separate init vector root in hash todo add auto-increasing version number
on every vault re-sign, with date and time todo: unit tests</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_data_write-instance_method" title="#add_data_write (instance method)">- (Object) <strong>add_data_write</strong>(username) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_user-instance_method" title="#add_user (instance method)">- (Object) <strong>add_user</strong>(request_file, options = { :make_owner =&gt; false }) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#add_vaultinfo_write-instance_method" title="#add_vaultinfo_write (instance method)">- (Object) <strong>add_vaultinfo_write</strong>(username) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#change_vault_name-instance_method" title="#change_vault_name (instance method)">- (Object) <strong>change_vault_name</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#current_user_key-instance_method" title="#current_user_key (instance method)">- (Object) <strong>current_user_key</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#current_user_name-instance_method" title="#current_user_name (instance method)">- (Object) <strong>current_user_name</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#current_user_pubkey-instance_method" title="#current_user_pubkey (instance method)">- (Object) <strong>current_user_pubkey</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#del_data_write-instance_method" title="#del_data_write (instance method)">- (Object) <strong>del_data_write</strong>(username) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#del_user-instance_method" title="#del_user (instance method)">- (Object) <strong>del_user</strong>(username) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#del_vaultinfo_write-instance_method" title="#del_vaultinfo_write (instance method)">- (Object) <strong>del_vaultinfo_write</strong>(username) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">- (MultiVault) <strong>initialize</strong>(options = { :action =&gt; {}, :cryptoset =&gt; {} }) </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>this loads multivault from a file, or creates a new one with a name it
loads the current user key or fails if no key is present action can be:
:load =&gt; &#39;file&#39;, :create =&gt; &#39;new name&#39; example mv =
Multivault.new( :action =&gt; { :load =&gt; &#39;somevault&#39; } )  ( or
with , :cryptoset =&gt; { .… }.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#re_cipher-instance_method" title="#re_cipher (instance method)">- (Object) <strong>re_cipher</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#re_digest-instance_method" title="#re_digest (instance method)">- (Object) <strong>re_digest</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#read_data-instance_method" title="#read_data (instance method)">- (Object) <strong>read_data</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#show_users-instance_method" title="#show_users (instance method)">- (Object) <strong>show_users</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#whoami-instance_method" title="#whoami (instance method)">- (Object) <strong>whoami</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#write_data-instance_method" title="#write_data (instance method)">- (Object) <strong>write_data</strong>(newdata_plain) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  
  
  <h3 class="inherited">Methods inherited from <span class='object_link'><a href="PreVault.html" title="PreVault (class)">PreVault</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="PreVault.html#sign_data-instance_method" title="PreVault#sign_data (method)">#sign_data</a></span>, <span class='object_link'><a href="PreVault.html#sign_vaultinfo-instance_method" title="PreVault#sign_vaultinfo (method)">#sign_vaultinfo</a></span>, <span class='object_link'><a href="PreVault.html#validate_data-instance_method" title="PreVault#validate_data (method)">#validate_data</a></span>, <span class='object_link'><a href="PreVault.html#validate_data_valkey-instance_method" title="PreVault#validate_data_valkey (method)">#validate_data_valkey</a></span>, <span class='object_link'><a href="PreVault.html#validate_vaultinfo-instance_method" title="PreVault#validate_vaultinfo (method)">#validate_vaultinfo</a></span>, <span class='object_link'><a href="PreVault.html#validate_vaultinfo_valkey-instance_method" title="PreVault#validate_vaultinfo_valkey (method)">#validate_vaultinfo_valkey</a></span>, <span class='object_link'><a href="PreVault.html#write_to_disk-instance_method" title="PreVault#write_to_disk (method)">#write_to_disk</a></span></p>

  <div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    - (<tt><span class='object_link'><a href="" title="MultiVault (class)">MultiVault</a></span></tt>) <strong>initialize</strong>(options = { :action =&gt; {}, :cryptoset =&gt; {} }) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>this loads multivault from a file, or creates a new one with a name it
loads the current user key or fails if no key is present action can be:
:load =&gt; &#39;file&#39;, :create =&gt; &#39;new name&#39; example mv =
Multivault.new( :action =&gt; { :load =&gt; &#39;somevault&#39; } )  ( or
with , :cryptoset =&gt; { .… }</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 181</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:action</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='comma'>,</span> <span class='symbol'>:cryptoset</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span><span class='rbrace'>}</span> <span class='rbrace'>}</span> <span class='rparen'>)</span>
  <span class='comment'># load current user key if it exists
</span>  <span class='id identifier rubyid_current_user_keyfile'>current_user_keyfile</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>HOME</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.multivault</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>user_private_key</span><span class='tstring_end'>&#39;</span></span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_current_user_info_file'>current_user_info_file</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>HOME</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>.multivault</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>user_info</span><span class='tstring_end'>&#39;</span></span> <span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_exists?'>exists?</span><span class='lparen'>(</span> <span class='id identifier rubyid_current_user_keyfile'>current_user_keyfile</span> <span class='rparen'>)</span>
    <span class='ivar'>@current_user_keyset</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>PKey</span><span class='op'>::</span><span class='const'>RSA</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span> <span class='id identifier rubyid_current_user_keyfile'>current_user_keyfile</span> <span class='rparen'>)</span>
    <span class='kw'>if</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_exists?'>exists?</span><span class='lparen'>(</span> <span class='id identifier rubyid_current_user_info_file'>current_user_info_file</span> <span class='rparen'>)</span>
    <span class='kw'>then</span>
      <span class='ivar'>@user_info</span> <span class='op'>=</span> <span class='const'>Hashr</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='const'>JSON</span><span class='period'>.</span><span class='id identifier rubyid_parse'>parse</span><span class='lparen'>(</span> <span class='const'>IO</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span><span class='lparen'>(</span> <span class='id identifier rubyid_current_user_info_file'>current_user_info_file</span> <span class='rparen'>)</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='comment'># an exeption is raised if keyfile exists without user info
</span>      <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Current user does not have an info file, please create one</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='comment'># cannot proceed without a keyfile
</span>    <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Current user does not have a keyfile, please create one</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>    
  <span class='comment'># if action is load from file, then do so
</span>  <span class='kw'>super</span><span class='lparen'>(</span> <span class='symbol'>:file</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span> <span class='symbol'>:action</span> <span class='rbracket'>]</span><span class='lbracket'>[</span> <span class='symbol'>:load</span> <span class='rbracket'>]</span>  <span class='rparen'>)</span> <span class='kw'>if</span> <span class='kw'>not</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span> <span class='symbol'>:action</span> <span class='rbracket'>]</span><span class='lbracket'>[</span> <span class='symbol'>:load</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='comment'># or create new vault
</span>  <span class='kw'>begin</span>
    <span class='id identifier rubyid_newvault'>newvault</span> <span class='op'>=</span> <span class='const'>Hashr</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='comment'># PreVault.new doesn&#39;t work...?
</span>    <span class='comment'># set name
</span>    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span> <span class='symbol'>:action</span> <span class='rbracket'>]</span><span class='lbracket'>[</span> <span class='symbol'>:create</span> <span class='rbracket'>]</span>
    <span class='comment'># set cryptoset, merge default into cryptoset options
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span> <span class='symbol'>:cryptoset</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_cryptoset'>cryptoset</span> <span class='op'>=</span> <span class='const'>DEFAULT_CRYPTOSET</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_cryptoset'>cryptoset</span> <span class='op'>=</span> <span class='const'>DEFAULT_CRYPTOSET</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span> <span class='symbol'>:cryptoset</span> <span class='rbracket'>]</span> <span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='comment'># create the current user, will be the only user and owner initialiy
</span>    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='symbol'>:user_pubkey</span> <span class='op'>=&gt;</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='ivar'>@current_user_keyset</span><span class='period'>.</span><span class='id identifier rubyid_public_key'>public_key</span><span class='period'>.</span><span class='id identifier rubyid_to_der'>to_der</span> <span class='rparen'>)</span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
    
    <span class='comment'># create the symmetric key cipher to encrypt the vaultinfo sign key
</span>    <span class='id identifier rubyid_vaultinfo_signkey_cipher'>vaultinfo_signkey_cipher</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>Cipher</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_cryptoset'>cryptoset</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_signkey_cipher'>vaultinfo_signkey_cipher</span> <span class='rparen'>)</span>
    <span class='id identifier rubyid_vaultinfo_signkey_cipher'>vaultinfo_signkey_cipher</span><span class='period'>.</span><span class='id identifier rubyid_encrypt'>encrypt</span>
    <span class='comment'># store the initialization vector (plain base64)
</span>    <span class='id identifier rubyid_newvault'>newvault</span><span class='lbracket'>[</span> <span class='symbol'>:initvectors</span> <span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:vaultinfo_signkey_init_vector</span> <span class='op'>=&gt;</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_vaultinfo_signkey_cipher'>vaultinfo_signkey_cipher</span><span class='period'>.</span><span class='id identifier rubyid_random_iv'>random_iv</span> <span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='comment'># store the symmetric key, but encrypt it with the current user public key, so only the current user can read it
</span>    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_sign_symkey'>vaultinfo_sign_symkey</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='ivar'>@current_user_keyset</span><span class='period'>.</span><span class='id identifier rubyid_public_encrypt'>public_encrypt</span><span class='lparen'>(</span> <span class='id identifier rubyid_vaultinfo_signkey_cipher'>vaultinfo_signkey_cipher</span><span class='period'>.</span><span class='id identifier rubyid_random_key'>random_key</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
    
    <span class='comment'># todo: a separate signkey for data and the vault itself would create the possibility of separate data and vault read/write rights
</span>    
    <span class='comment'># create vaultinfo signkey, public part is vaultinfo validation key, private part will be encypted with vaultinfo_signkey_cipher
</span>    <span class='id identifier rubyid_vaultinfo_signkeypair'>vaultinfo_signkeypair</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>PKey</span><span class='op'>::</span><span class='const'>RSA</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='int'>4096</span> <span class='rparen'>)</span>
    <span class='comment'># store validation key (public part of signkey) in strict RFC 4648 to avoid problems with signature validation, 
</span>    <span class='comment'># use DER format for the same reason (pem is not properly specified)
</span>    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_keysets'>keysets</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:vaultinfo_valkey</span> <span class='op'>=&gt;</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_vaultinfo_signkeypair'>vaultinfo_signkeypair</span><span class='period'>.</span><span class='id identifier rubyid_public_key'>public_key</span><span class='period'>.</span><span class='id identifier rubyid_to_der'>to_der</span> <span class='rparen'>)</span> <span class='rbrace'>}</span>
    <span class='comment'># encrypt private vaultinfo_signkey with with vaultinfo_sign_symkey and store base64
</span>    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_keysets'>keysets</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_signkey'>vaultinfo_signkey</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_vaultinfo_signkey_cipher'>vaultinfo_signkey_cipher</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span> <span class='id identifier rubyid_vaultinfo_signkeypair'>vaultinfo_signkeypair</span><span class='period'>.</span><span class='id identifier rubyid_to_der'>to_der</span> <span class='rparen'>)</span> <span class='op'>+</span> <span class='id identifier rubyid_vaultinfo_signkey_cipher'>vaultinfo_signkey_cipher</span><span class='period'>.</span><span class='id identifier rubyid_final'>final</span> <span class='rparen'>)</span>
  
    <span class='comment'># create the symmetric key cipher to encrypt the data sign key
</span>    <span class='id identifier rubyid_data_signkey_cipher'>data_signkey_cipher</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>Cipher</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_cryptoset'>cryptoset</span><span class='period'>.</span><span class='id identifier rubyid_data_signkey_cipher'>data_signkey_cipher</span> <span class='rparen'>)</span>
    <span class='id identifier rubyid_data_signkey_cipher'>data_signkey_cipher</span><span class='period'>.</span><span class='id identifier rubyid_encrypt'>encrypt</span>
    <span class='comment'># store the initialization vector (plain base64)
</span>    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_initvectors'>initvectors</span><span class='period'>.</span><span class='id identifier rubyid_data_signkey_init_vector'>data_signkey_init_vector</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_data_signkey_cipher'>data_signkey_cipher</span><span class='period'>.</span><span class='id identifier rubyid_random_iv'>random_iv</span> <span class='rparen'>)</span> 
    <span class='comment'># store the symmetric key, but encrypt it with the current user public key, so only the current user can read it
</span>    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_data_sign_symkey'>data_sign_symkey</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='ivar'>@current_user_keyset</span><span class='period'>.</span><span class='id identifier rubyid_public_encrypt'>public_encrypt</span><span class='lparen'>(</span> <span class='id identifier rubyid_data_signkey_cipher'>data_signkey_cipher</span><span class='period'>.</span><span class='id identifier rubyid_random_key'>random_key</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
    
    
    <span class='comment'># create data signkey, public part is data validation key, private part will be encypted with data_signkey_cipher
</span>    <span class='id identifier rubyid_data_signkeypair'>data_signkeypair</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>PKey</span><span class='op'>::</span><span class='const'>RSA</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='int'>4096</span> <span class='rparen'>)</span>
    <span class='comment'># store validation key (public part of signkey) in strict RFC 4648 to avoid problems with signature validation, 
</span>    <span class='comment'># use DER format for the same reason (pem is not properly specified)
</span>    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_keysets'>keysets</span><span class='period'>.</span><span class='id identifier rubyid_data_valkey'>data_valkey</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_data_signkeypair'>data_signkeypair</span><span class='period'>.</span><span class='id identifier rubyid_public_key'>public_key</span><span class='period'>.</span><span class='id identifier rubyid_to_der'>to_der</span> <span class='rparen'>)</span> 
    <span class='comment'># encrypt private data_signkey with with data_sign_symkey and store base64
</span>    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_keysets'>keysets</span><span class='period'>.</span><span class='id identifier rubyid_data_signkey'>data_signkey</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_data_signkey_cipher'>data_signkey_cipher</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span> <span class='id identifier rubyid_data_signkeypair'>data_signkeypair</span><span class='period'>.</span><span class='id identifier rubyid_to_der'>to_der</span> <span class='rparen'>)</span> <span class='op'>+</span> <span class='id identifier rubyid_data_signkey_cipher'>data_signkey_cipher</span><span class='period'>.</span><span class='id identifier rubyid_final'>final</span> <span class='rparen'>)</span>     
    
    
    
    
    <span class='comment'># create the symmetric key cipher to encrypt the data
</span>    <span class='id identifier rubyid_data_cipher'>data_cipher</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>Cipher</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_cryptoset'>cryptoset</span><span class='period'>.</span><span class='id identifier rubyid_data_cipher'>data_cipher</span> <span class='rparen'>)</span>
    <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_encrypt'>encrypt</span>
    <span class='comment'># store the initialization vector (plain base64)
</span>    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_initvectors'>initvectors</span><span class='period'>.</span><span class='id identifier rubyid_data_init_vector'>data_init_vector</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_random_iv'>random_iv</span> <span class='rparen'>)</span>
    <span class='comment'># store the symmetric key, but encrypt it with the current user public key, so only the current user can read it
</span>    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_data_symkey'>data_symkey</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='ivar'>@current_user_keyset</span><span class='period'>.</span><span class='id identifier rubyid_public_encrypt'>public_encrypt</span><span class='lparen'>(</span> <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_random_key'>random_key</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
    
    <span class='comment'># encrypt the data
</span>    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:encrypted_data</span> <span class='op'>=&gt;</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span> <span class='const'>DEFAULT_DATA</span> <span class='rparen'>)</span> <span class='op'>+</span> <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_final'>final</span> <span class='rparen'>)</span> <span class='rbrace'>}</span>
    
    <span class='comment'># there are 4 type of signatures, the data signature, the vaultinfo validation key signature (one for every user), the vaultconfig signature and the data validation key signature
</span>    <span class='comment'># note that signatures are derived from what is actualy in the vault, the Base64 encoded, encrypted data, not on the data or the encrypted data itself
</span>    
    <span class='id identifier rubyid_data_digest'>data_digest</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>Digest</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_cryptoset'>cryptoset</span><span class='period'>.</span><span class='id identifier rubyid_data_digest'>data_digest</span> <span class='rparen'>)</span>
    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_signatures'>signatures</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:data_signature</span> <span class='op'>=&gt;</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_data_signkeypair'>data_signkeypair</span><span class='period'>.</span><span class='id identifier rubyid_sign'>sign</span><span class='lparen'>(</span> <span class='id identifier rubyid_data_digest'>data_digest</span><span class='comma'>,</span> <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_encrypted_data'>encrypted_data</span> <span class='rparen'>)</span> <span class='rparen'>)</span> <span class='rbrace'>}</span>
    
    <span class='comment'># use the private key of the current user (owner) to sign the vaultinfo validation key, again on what is actualy in the vault (the base64 encoded validation key)
</span>    <span class='id identifier rubyid_vaultinfo_valkey_digest'>vaultinfo_valkey_digest</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>Digest</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_cryptoset'>cryptoset</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_valkey_digest'>vaultinfo_valkey_digest</span> <span class='rparen'>)</span>
    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_valkey_signature'>vaultinfo_valkey_signature</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='ivar'>@current_user_keyset</span><span class='period'>.</span><span class='id identifier rubyid_sign'>sign</span><span class='lparen'>(</span> <span class='id identifier rubyid_vaultinfo_valkey_digest'>vaultinfo_valkey_digest</span><span class='comma'>,</span> <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_keysets'>keysets</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_valkey'>vaultinfo_valkey</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
    
    <span class='comment'># use the private key of the current user (owner) to sign the data validation key, again on what is actualy in the vault (the base64 encoded validation key)
</span>    <span class='id identifier rubyid_data_valkey_digest'>data_valkey_digest</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>Digest</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_cryptoset'>cryptoset</span><span class='period'>.</span><span class='id identifier rubyid_data_valkey_digest'>data_valkey_digest</span> <span class='rparen'>)</span>
    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_data_valkey_signature'>data_valkey_signature</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='ivar'>@current_user_keyset</span><span class='period'>.</span><span class='id identifier rubyid_sign'>sign</span><span class='lparen'>(</span> <span class='id identifier rubyid_data_valkey_digest'>data_valkey_digest</span><span class='comma'>,</span> <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_keysets'>keysets</span><span class='period'>.</span><span class='id identifier rubyid_data_valkey'>data_valkey</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
    
    <span class='comment'># the signature on the vault itself should be consistent and repeatable, but hashes do not have any inherent order
</span>    <span class='comment'># so the digest is based on: a concatenated( sorted list of key + valuedigest concatenated ), again based on the values actualy in the vault.
</span>    <span class='comment'># all except the data and signatures themselves are used to create the signature
</span>    <span class='comment'># the signature is make with signkey
</span>    <span class='id identifier rubyid_vaultinfo_digest'>vaultinfo_digest</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>Digest</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_cryptoset'>cryptoset</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_digest'>vaultinfo_digest</span> <span class='rparen'>)</span>
    <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_signatures'>signatures</span><span class='period'>.</span><span class='id identifier rubyid_vaultconfig_signature'>vaultconfig_signature</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_vaultinfo_signkeypair'>vaultinfo_signkeypair</span><span class='period'>.</span><span class='id identifier rubyid_sign'>sign</span><span class='lparen'>(</span> <span class='id identifier rubyid_vaultinfo_digest'>vaultinfo_digest</span><span class='comma'>,</span> <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_except'>except</span><span class='lparen'>(</span> <span class='symbol'>:signatures</span><span class='comma'>,</span> <span class='symbol'>:data</span><span class='comma'>,</span> <span class='symbol'>:initvectors</span>  <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_digestable'>digestable</span><span class='lparen'>(</span> <span class='symbol'>:digest</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_newvault'>newvault</span><span class='period'>.</span><span class='id identifier rubyid_cryptoset'>cryptoset</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_digest'>vaultinfo_digest</span> <span class='rparen'>)</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
    
    <span class='kw'>super</span><span class='lparen'>(</span> <span class='id identifier rubyid_newvault'>newvault</span> <span class='rparen'>)</span>
  <span class='kw'>end</span> <span class='kw'>if</span> <span class='kw'>not</span> <span class='id identifier rubyid_options'>options</span><span class='lbracket'>[</span> <span class='symbol'>:action</span> <span class='rbracket'>]</span><span class='lbracket'>[</span> <span class='symbol'>:create</span> <span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="add_data_write-instance_method">
  
    - (<tt>Object</tt>) <strong>add_data_write</strong>(username) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


359
360
361
362
363
364
365
366
367
368
369
370
371
372</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 359</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_data_write'>add_data_write</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span> <span class='rparen'>)</span>
  <span class='comment'># this will add data write capability to a user by adding data_sign_symkey for the user
</span>  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must have vaultinfo_write capabilities to change user info</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_sign_symkey'>vaultinfo_sign_symkey</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must have data write capabilities to give another user data write access</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_data_sign_symkey'>data_sign_symkey</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No such user</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User already has data write capabilities</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>not</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_data_sign_symkey'>data_sign_symkey</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_validate_vaultinfo'>validate_vaultinfo</span>
  <span class='comment'># add data write capabilities by adding sign_symkey encypted with public key of the new data writer
</span>  <span class='id identifier rubyid_newcap_pubkey'>newcap_pubkey</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>PKey</span><span class='op'>::</span><span class='const'>RSA</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_decode64'>strict_decode64</span><span class='lparen'>(</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_user_pubkey'>user_pubkey</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_data_sign_symkey'>data_sign_symkey</span> <span class='op'>=</span>  <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_newcap_pubkey'>newcap_pubkey</span><span class='period'>.</span><span class='id identifier rubyid_public_encrypt'>public_encrypt</span><span class='lparen'>(</span>  <span class='ivar'>@current_user_keyset</span><span class='period'>.</span><span class='id identifier rubyid_private_decrypt'>private_decrypt</span><span class='lparen'>(</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_decode64'>strict_decode64</span><span class='lparen'>(</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_data_sign_symkey'>data_sign_symkey</span> <span class='rparen'>)</span> <span class='rparen'>)</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sign_vaultinfo'>sign_vaultinfo</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="add_user-instance_method">
  
    - (<tt>Object</tt>) <strong>add_user</strong>(request_file, options = { :make_owner =&gt; false }) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 310</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_user'>add_user</span><span class='lparen'>(</span> <span class='id identifier rubyid_request_file'>request_file</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:make_owner</span> <span class='op'>=&gt;</span> <span class='kw'>false</span> <span class='rbrace'>}</span> <span class='rparen'>)</span>
  
  <span class='comment'># todo: check if vault name matches request
</span>  
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must be owner to add user</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_sign_symkey'>vaultinfo_sign_symkey</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='comment'># load request from file
</span>  <span class='id identifier rubyid_access_request'>access_request</span> <span class='op'>=</span> <span class='const'>PreVault</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='symbol'>:file</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_request_file'>request_file</span> <span class='rparen'>)</span>
  
  <span class='comment'># validate vault itself first (will also validate valkey)
</span>  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_validate_vaultinfo'>validate_vaultinfo</span>
  
  <span class='comment'># validate signature on vaultinfo valkey with user pubkey and vaultinfo valkey from vault
</span>  <span class='id identifier rubyid_newuser_pubkey'>newuser_pubkey</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>PKey</span><span class='op'>::</span><span class='const'>RSA</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_decode64'>strict_decode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_access_request'>access_request</span><span class='period'>.</span><span class='id identifier rubyid_user_pubkey'>user_pubkey</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_vaultinfo_valkey_digest'>vaultinfo_valkey_digest</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>Digest</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_cryptoset'>cryptoset</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_valkey_digest'>vaultinfo_valkey_digest</span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unable to validate vaultinfo_valkey signature for new user</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>not</span> <span class='id identifier rubyid_newuser_pubkey'>newuser_pubkey</span><span class='period'>.</span><span class='id identifier rubyid_verify'>verify</span><span class='lparen'>(</span> <span class='id identifier rubyid_vaultinfo_valkey_digest'>vaultinfo_valkey_digest</span> <span class='comma'>,</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_decode64'>strict_decode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_access_request'>access_request</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_valkey_signature'>vaultinfo_valkey_signature</span> <span class='rparen'>)</span><span class='comma'>,</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_keysets'>keysets</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_valkey'>vaultinfo_valkey</span> <span class='rparen'>)</span>
  
  <span class='comment'># validate signature on data valkey with user pubkey and data valkey from vault
</span>  <span class='id identifier rubyid_data_valkey_digest'>data_valkey_digest</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>Digest</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_cryptoset'>cryptoset</span><span class='period'>.</span><span class='id identifier rubyid_data_valkey_digest'>data_valkey_digest</span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Unable to validate data_valkey signature for new user</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>not</span> <span class='id identifier rubyid_newuser_pubkey'>newuser_pubkey</span><span class='period'>.</span><span class='id identifier rubyid_verify'>verify</span><span class='lparen'>(</span> <span class='id identifier rubyid_data_valkey_digest'>data_valkey_digest</span> <span class='comma'>,</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_decode64'>strict_decode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_access_request'>access_request</span><span class='period'>.</span><span class='id identifier rubyid_data_valkey_signature'>data_valkey_signature</span> <span class='rparen'>)</span><span class='comma'>,</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_keysets'>keysets</span><span class='period'>.</span><span class='id identifier rubyid_data_valkey'>data_valkey</span> <span class='rparen'>)</span>    
  
  
  <span class='comment'># add user public key and validation signatures
</span>  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='lbracket'>[</span> <span class='id identifier rubyid_access_request'>access_request</span><span class='period'>.</span><span class='id identifier rubyid_user_name'>user_name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rbracket'>]</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='symbol'>:user_pubkey</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_access_request'>access_request</span><span class='period'>.</span><span class='id identifier rubyid_user_pubkey'>user_pubkey</span><span class='comma'>,</span> <span class='symbol'>:vaultinfo_valkey_signature</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_access_request'>access_request</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_valkey_signature'>vaultinfo_valkey_signature</span><span class='comma'>,</span> <span class='symbol'>:data_valkey_signature</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_access_request'>access_request</span><span class='period'>.</span><span class='id identifier rubyid_data_valkey_signature'>data_valkey_signature</span> <span class='rbrace'>}</span>
  
  <span class='comment'># give the user a symmetric key for data decryption, encrypted with the newusers&#39; public key
</span>  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_access_request'>access_request</span><span class='period'>.</span><span class='id identifier rubyid_user_name'>user_name</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_data_symkey'>data_symkey</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_newuser_pubkey'>newuser_pubkey</span><span class='period'>.</span><span class='id identifier rubyid_public_encrypt'>public_encrypt</span><span class='lparen'>(</span> <span class='ivar'>@current_user_keyset</span><span class='period'>.</span><span class='id identifier rubyid_private_decrypt'>private_decrypt</span><span class='lparen'>(</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_decode64'>strict_decode64</span><span class='lparen'>(</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_data_symkey'>data_symkey</span> <span class='rparen'>)</span> <span class='rparen'>)</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
  
  <span class='comment'># re-sign vault info
</span>  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sign_vaultinfo'>sign_vaultinfo</span>
  
  <span class='comment'># todo: do something with make_owner if true
</span>  
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="add_vaultinfo_write-instance_method">
  
    - (<tt>Object</tt>) <strong>add_vaultinfo_write</strong>(username) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


385
386
387
388
389
390
391
392
393
394
395
396
397
398</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 385</span>

<span class='kw'>def</span> <span class='id identifier rubyid_add_vaultinfo_write'>add_vaultinfo_write</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='rparen'>)</span>
  <span class='comment'># this will add vaultinfo write capabilities to a user, allowing to create users
</span>  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must have vaultinfo_write capabilities to change user info</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_sign_symkey'>vaultinfo_sign_symkey</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No such user</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User already has vaultinfo write capabilities</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>not</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_sign_symkey'>vaultinfo_sign_symkey</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_validate_vaultinfo'>validate_vaultinfo</span>
  <span class='comment'># add vaultinfo write capabilities by adding sign_symkey encypted with public key of the new vault administrator
</span>  <span class='id identifier rubyid_newcap_pubkey'>newcap_pubkey</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>PKey</span><span class='op'>::</span><span class='const'>RSA</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_decode64'>strict_decode64</span><span class='lparen'>(</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_user_pubkey'>user_pubkey</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_sign_symkey'>vaultinfo_sign_symkey</span> <span class='op'>=</span>  <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_newcap_pubkey'>newcap_pubkey</span><span class='period'>.</span><span class='id identifier rubyid_public_encrypt'>public_encrypt</span><span class='lparen'>(</span>  <span class='ivar'>@current_user_keyset</span><span class='period'>.</span><span class='id identifier rubyid_private_decrypt'>private_decrypt</span><span class='lparen'>(</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_decode64'>strict_decode64</span><span class='lparen'>(</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_sign_symkey'>vaultinfo_sign_symkey</span> <span class='rparen'>)</span> <span class='rparen'>)</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sign_vaultinfo'>sign_vaultinfo</span>
  
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="change_vault_name-instance_method">
  
    - (<tt>Object</tt>) <strong>change_vault_name</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


417
418
419</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 417</span>

<span class='kw'>def</span> <span class='id identifier rubyid_change_vault_name'>change_vault_name</span>
  <span class='comment'># notimplemented yet
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="current_user_key-instance_method">
  
    - (<tt>Object</tt>) <strong>current_user_key</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


443
444
445
446</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 443</span>

<span class='kw'>def</span> <span class='id identifier rubyid_current_user_key'>current_user_key</span>
  <span class='comment'># returns current user keypair (for MVaultHelper)
</span>  <span class='ivar'>@current_user_keyset</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="current_user_name-instance_method">
  
    - (<tt>Object</tt>) <strong>current_user_name</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


433
434
435
436</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 433</span>

<span class='kw'>def</span> <span class='id identifier rubyid_current_user_name'>current_user_name</span>
  <span class='comment'># returns current user name (for MVaultHelper )
</span>  <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="current_user_pubkey-instance_method">
  
    - (<tt>Object</tt>) <strong>current_user_pubkey</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


438
439
440
441</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 438</span>

<span class='kw'>def</span> <span class='id identifier rubyid_current_user_pubkey'>current_user_pubkey</span>
  <span class='comment'># returns current user pubkey in base64 (for MVaultHelper )
</span>  <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='ivar'>@current_user_keyset</span><span class='period'>.</span><span class='id identifier rubyid_public_key'>public_key</span><span class='period'>.</span><span class='id identifier rubyid_to_der'>to_der</span> <span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="del_data_write-instance_method">
  
    - (<tt>Object</tt>) <strong>del_data_write</strong>(username) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


374
375
376
377
378
379
380
381
382
383</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 374</span>

<span class='kw'>def</span> <span class='id identifier rubyid_del_data_write'>del_data_write</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span> <span class='rparen'>)</span> 
  <span class='comment'># this will remove data write capability by removing data_sign_symkey for a user
</span>  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must have vaultinfo_write capabilities to change user info</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_sign_symkey'>vaultinfo_sign_symkey</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No such user</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User doesn&#39;t have data write capabilities</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_data_sign_symkey'>data_sign_symkey</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_validate_vaultinfo'>validate_vaultinfo</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span> <span class='symbol'>:data_sign_symkey</span> <span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sign_vaultinfo'>sign_vaultinfo</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="del_user-instance_method">
  
    - (<tt>Object</tt>) <strong>del_user</strong>(username) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


344
345
346
347
348
349
350
351
352
353
354
355
356
357</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 344</span>

<span class='kw'>def</span> <span class='id identifier rubyid_del_user'>del_user</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span> <span class='rparen'>)</span>
  <span class='comment'># deletes a user
</span>  <span class='comment'># todo: owner cannot delete self, sign function needs users&#39; signkey_symkey
</span>  
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must have vaultinfo write capabilities to delete user</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_sign_symkey'>vaultinfo_sign_symkey</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No such user</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_validate_vaultinfo'>validate_vaultinfo</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sign_vaultinfo'>sign_vaultinfo</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="del_vaultinfo_write-instance_method">
  
    - (<tt>Object</tt>) <strong>del_vaultinfo_write</strong>(username) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


400
401
402
403
404
405
406
407
408
409
410</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 400</span>

<span class='kw'>def</span> <span class='id identifier rubyid_del_vaultinfo_write'>del_vaultinfo_write</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span> <span class='rparen'>)</span>
  <span class='comment'># this will delete vaultinfo write capabilities
</span>  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must have vaultinfo_write capabilities to change user info</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_sign_symkey'>vaultinfo_sign_symkey</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No such user</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User doesn&#39;t have vaultinfo write capabilities</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_vaultinfo_sign_symkey'>vaultinfo_sign_symkey</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_validate_vaultinfo'>validate_vaultinfo</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='id identifier rubyid_username'>username</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span> <span class='symbol'>:vaultinfo_sign_symkey</span> <span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sign_vaultinfo'>sign_vaultinfo</span>
  
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="re_cipher-instance_method">
  
    - (<tt>Object</tt>) <strong>re_cipher</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


421
422
423</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 421</span>

<span class='kw'>def</span> <span class='id identifier rubyid_re_cipher'>re_cipher</span>
  <span class='comment'># re-crypting (with another cipher) not implemented yet
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="re_digest-instance_method">
  
    - (<tt>Object</tt>) <strong>re_digest</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


425
426
427</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 425</span>

<span class='kw'>def</span> <span class='id identifier rubyid_re_digest'>re_digest</span>
  <span class='comment'># ruminate not implemented yet
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="read_data-instance_method">
  
    - (<tt>Object</tt>) <strong>read_data</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


288
289
290
291
292
293
294
295</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 288</span>

<span class='kw'>def</span> <span class='id identifier rubyid_read_data'>read_data</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_validate_data'>validate_data</span>
  <span class='id identifier rubyid_data_cipher'>data_cipher</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>Cipher</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_cryptoset'>cryptoset</span><span class='period'>.</span><span class='id identifier rubyid_data_cipher'>data_cipher</span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_decrypt'>decrypt</span>
  <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_iv'>iv</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_decode64'>strict_decode64</span><span class='lparen'>(</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_initvectors'>initvectors</span><span class='period'>.</span><span class='id identifier rubyid_data_init_vector'>data_init_vector</span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='ivar'>@current_user_keyset</span><span class='period'>.</span><span class='id identifier rubyid_private_decrypt'>private_decrypt</span><span class='lparen'>(</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_decode64'>strict_decode64</span><span class='lparen'>(</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_data_symkey'>data_symkey</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_decode64'>strict_decode64</span><span class='lparen'>(</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_encrypted_data'>encrypted_data</span> <span class='rparen'>)</span> <span class='rparen'>)</span> <span class='op'>+</span> <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_final'>final</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="show_users-instance_method">
  
    - (<tt>Object</tt>) <strong>show_users</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


412
413
414
415</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 412</span>

<span class='kw'>def</span> <span class='id identifier rubyid_show_users'>show_users</span>
  <span class='comment'># show users and their rights
</span>  <span class='comment'># not implemented yet
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="whoami-instance_method">
  
    - (<tt>Object</tt>) <strong>whoami</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


429
430
431</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 429</span>

<span class='kw'>def</span> <span class='id identifier rubyid_whoami'>whoami</span>
  <span class='comment'># not implemented yet
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="write_data-instance_method">
  
    - (<tt>Object</tt>) <strong>write_data</strong>(newdata_plain) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


297
298
299
300
301
302
303
304
305
306
307
308</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/multivault.rb', line 297</span>

<span class='kw'>def</span> <span class='id identifier rubyid_write_data'>write_data</span><span class='lparen'>(</span> <span class='id identifier rubyid_newdata_plain'>newdata_plain</span> <span class='rparen'>)</span>
  <span class='comment'># set and sign
</span>  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must have data write capabilities to change data</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_data_sign_symkey'>data_sign_symkey</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Vault should not be empty</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_newdata_plain'>newdata_plain</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='comment'># todo: allow empty data
</span>  <span class='id identifier rubyid_data_cipher'>data_cipher</span> <span class='op'>=</span> <span class='const'>OpenSSL</span><span class='op'>::</span><span class='const'>Cipher</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_cryptoset'>cryptoset</span><span class='period'>.</span><span class='id identifier rubyid_data_cipher'>data_cipher</span> <span class='rparen'>)</span>
  <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_encrypt'>encrypt</span>
  <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_key'>key</span> <span class='op'>=</span> <span class='ivar'>@current_user_keyset</span><span class='period'>.</span><span class='id identifier rubyid_private_decrypt'>private_decrypt</span><span class='lparen'>(</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_decode64'>strict_decode64</span><span class='lparen'>(</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_send'>send</span><span class='lparen'>(</span> <span class='ivar'>@user_info</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='period'>.</span><span class='id identifier rubyid_to_sym'>to_sym</span> <span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_data_symkey'>data_symkey</span> <span class='rparen'>)</span> <span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_initvectors'>initvectors</span><span class='period'>.</span><span class='id identifier rubyid_data_init_vector'>data_init_vector</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_random_iv'>random_iv</span> <span class='rparen'>)</span> 
  <span class='comment'># self.sign_vaultinfo # if we move data_init_vector to data we don&#39;t have to re-sign the vault itself for write_data
</span>  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_encrypted_data'>encrypted_data</span> <span class='op'>=</span> <span class='const'>Base64</span><span class='period'>.</span><span class='id identifier rubyid_strict_encode64'>strict_encode64</span><span class='lparen'>(</span> <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span> <span class='id identifier rubyid_newdata_plain'>newdata_plain</span> <span class='rparen'>)</span> <span class='op'>+</span> <span class='id identifier rubyid_data_cipher'>data_cipher</span><span class='period'>.</span><span class='id identifier rubyid_final'>final</span> <span class='rparen'>)</span>
  <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_sign_data'>sign_data</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Mon May 23 12:45:28 2016 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.0.0).
</div>

  </body>
</html>